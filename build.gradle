import com.enonic.uitest.server.KarafServer

apply plugin: 'groovy'

repositories {
    mavenLocal()
    mavenCentral()
    maven {
        url 'http://repo.enonic.com/public'
    }
}

configurations {
    distro
}

dependencies {
    compile 'org.seleniumhq.selenium:selenium-java:2.43.1'
    compile 'com.enonic.wem:wem-api:5.0.0-SNAPSHOT'
    compile 'log4j:log4j:1.2.17'
    compile 'org.codehaus.groovy:groovy-all:2.1.8'
    compile 'org.spockframework:spock-core:0.7-groovy-2.0'
    compile 'org.gebish:geb-spock:0.9.2'

    distro 'com.enonic.wem:wem-distro:5.0.0-SNAPSHOT@zip'
    distro 'com.enonic.wem.modules:xeon:1.0.0@jar'
    distro 'com.enonic.wem.modules:seedsavers:1.0.0@jar'
}

test {

}
task startServer << {
    ext.karafServer = new KarafServer()
    ext.karafServer.files( configurations.distro.resolve() )
    ext.karafServer.startupDelay( 10000 )
    ext.karafServer.unpackDir( file( 'build/karaf' ) )
    ext.karafServer.start()
}

task stopServer << {
    startServer.karafServer.stop()
}

task clearData( type: Test, dependsOn: ['startServer'] ) << {
    excludes = ['**/*Spec.*']
    include '**/CleanAndInitializeDataSpec.class'
    // include 'test/groovy/com/enonic/wem/uitest/content/CleanAndInitializeDataSpec.class'
    // include '/test/groovy/com/enonic/wem/uitest/content/CleanAndInitializeDataSpec.class'
}

task testEmbedded( type: Test, dependsOn: [clearData] ) << {
    scanForTestClasses = false
    include '**/*Spec.class'
    exclude '**/CleanAndInitializeDataSpec.class'
    forkEvery = null
}
testEmbedded.finalizedBy = [stopServer]

