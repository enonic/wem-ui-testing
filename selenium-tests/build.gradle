import com.enonic.uitest.server.KarafServer

apply plugin: 'groovy'

configurations {
    distro
}

dependencies {
    compile 'org.seleniumhq.selenium:selenium-java:2.44.0'
    compile 'com.enonic.xp:core-api:5.0.0-SNAPSHOT'
    compile 'log4j:log4j:1.2.17'
    compile 'org.codehaus.groovy:groovy-all:2.1.8'
    compile 'org.spockframework:spock-core:0.7-groovy-2.0'
    compile 'org.gebish:geb-spock:0.10.0'


    distro 'com.enonic.xp:distro:5.0.0-SNAPSHOT@zip'
    distro 'com.enonic.wem.modules:features:1.0.0@jar'
    distro 'com.enonic.wem.modules:demo:1.0.0@jar'
}

test {

}

task buildModules(
    dependsOn: [':test-modules:first-module:install', ':test-modules:simple-page:install', ':test-modules:all-contenttypes:install'] )

task startServer << {
    logging.captureStandardOutput LogLevel.INFO
    ext.karafServer = new KarafServer()
    ext.karafServer.files( configurations.distro.resolve() )
    ext.karafServer.startupDelay( 50000 )
    ext.karafServer.unpackDir( file( 'build/karaf' ) )
    ext.karafServer.start()
}

task stopServer << {
    startServer.karafServer.stop()
}

//task clearData( type: Test, dependsOn: ['installModules'] ) {
task clearData( type: Test, dependsOn: ['startServer'] ) {
    scanForTestClasses = true
    exclude '**/*Spec.class'
    exclude '**/*Suite.*'
    include '**/CleanAndInitializeData.class'
}

task installSimpleSiteModule( type: Test, dependsOn: ['buildModules', 'startServer'] ) {

    scanForTestClasses = true
    exclude '**/*Spec.class'
    include '**/liveedit/InstallSimpleSiteModule.class'
}

tasks.withType( Test ) {
    jvmArgs '-Xms128m', '-Xmx1024m'
    testLogging {
        exceptionFormat "full"
        events "started", "passed", "skipped", "failed", "standardOut", "standardError"
        displayGranularity = 0
    }
}
task testEmbedded( type: Test, dependsOn: [startServer, clearData] ) {
    scanForTestClasses = false
    include '**/*Spec.class'
    exclude '**/CleanAndInitializeData.class'
    exclude '**/content/ContentUploadSpec.class'
    exclude '**/content/liveedit/**Spec.class'
    forkEvery = null
}

task testSimpleSiteLiveEdit( type: Test, dependsOn: ['startServer', 'installSimpleSiteModule', 'clearData'] ) {
    scanForTestClasses = false

    include '**/liveedit/CreateSiteWithLayoutSpec.class'
    exclude '**/CleanAndInitializeData.class'

    exclude '**/module/**'
    exclude '**/user/**'
    forkEvery = null
}

task testUploadContent( type: Test, dependsOn: ['clearData'] ) {
    scanForTestClasses = false
    exclude '**/CleanAndInitializeData.class'
    exclude '**/module/**'
    exclude '**/user/**'
    include '**/content/ContentUploadSpec.class'
    forkEvery = null
}
testEmbedded.finalizedBy = ['stopServer']

